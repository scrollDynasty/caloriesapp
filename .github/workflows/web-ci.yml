name: Web CI/CD

on:
  push:
    branches: [master, development]
    paths: ['web/**', '.github/workflows/web-ci.yml']
  pull_request:
    branches: [master, development]
    paths: ['web/**', '.github/workflows/web-ci.yml']

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json
      - run: npm ci --include=dev
      - run: npm run build
        env:
          NODE_ENV: production

  deploy-prod:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json
      - run: |
          cd web
          npm ci --include=dev
          npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: https://api.yeb-ich.com
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - run: ssh-keyscan -H yeb-ich.com >> ~/.ssh/known_hosts
      - run: |
          cd web/out
          tar -czf /tmp/web.tar.gz .
          scp /tmp/web.tar.gz scroll@yeb-ich.com:/tmp/
          ssh scroll@yeb-ich.com 'set -e; REMOTE_DIR="/var/www/yeb-ich.com/html"; sudo mkdir -p $REMOTE_DIR; if [ -d "$REMOTE_DIR/current" ]; then sudo rm -rf $REMOTE_DIR/backup; sudo mv $REMOTE_DIR/current $REMOTE_DIR/backup; fi; sudo mkdir -p $REMOTE_DIR/current; cd /tmp; mkdir -p web_extract; cd web_extract; tar -xzf /tmp/web.tar.gz; sudo cp -r . $REMOTE_DIR/current/; rm -rf /tmp/web_extract /tmp/web.tar.gz; cd $REMOTE_DIR; sudo rm -rf *.html *.js *.json _next 2>/dev/null || true; sudo cp -r current/* .; sudo chown -R www-data:www-data $REMOTE_DIR; sudo chmod -R 755 $REMOTE_DIR; sudo nginx -t && sudo systemctl reload nginx'

  deploy-dev:
    name: Deploy Development
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/development' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json
      - run: |
          cd web
          npm ci --include=dev
          npm run build
        env:
          NODE_ENV: development
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - run: ssh-keyscan -H yeb-ich.com >> ~/.ssh/known_hosts
      - run: |
          cd web/out
          tar -czf /tmp/web-dev.tar.gz .
          scp /tmp/web-dev.tar.gz scroll@yeb-ich.com:/tmp/
          ssh scroll@yeb-ich.com 'set -e; REMOTE_DIR="/var/www/yeb-ich.com/html-dev"; sudo mkdir -p $REMOTE_DIR; if [ -d "$REMOTE_DIR/current" ]; then sudo rm -rf $REMOTE_DIR/backup; sudo mv $REMOTE_DIR/current $REMOTE_DIR/backup; fi; sudo mkdir -p $REMOTE_DIR/current; cd /tmp; mkdir -p web_extract; cd web_extract; tar -xzf /tmp/web-dev.tar.gz; sudo cp -r . $REMOTE_DIR/current/; rm -rf /tmp/web_extract /tmp/web-dev.tar.gz; cd $REMOTE_DIR; sudo rm -rf *.html *.js *.json _next 2>/dev/null || true; sudo cp -r current/* .; sudo chown -R www-data:www-data $REMOTE_DIR; sudo chmod -R 755 $REMOTE_DIR'
