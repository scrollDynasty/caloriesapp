name: Backend CI/CD

on:
  push:
    branches: [master, development]
    paths: ['backend/**', '.github/workflows/backend-ci.yml']
  pull_request:
    branches: [master, development]
    paths: ['backend/**', '.github/workflows/backend-ci.yml']

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - run: |
          python -m pip install --upgrade pip --quiet
          pip install -r requirements.txt --quiet
      - run: python -c "from app.main import app; print('OK')"

  deploy-prod:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: check
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - run: ssh-keyscan -H api.yeb-ich.com >> ~/.ssh/known_hosts
      - run: |
          cd backend
          tar -czf /tmp/backend.tar.gz .
          scp /tmp/backend.tar.gz scroll@api.yeb-ich.com:/tmp/
          ssh scroll@api.yeb-ich.com 'set -e; BACKEND_DIR="/home/scroll/backend"; mkdir -p "$BACKEND_DIR"; cd "$BACKEND_DIR"; tar -xzf /tmp/backend.tar.gz; rm /tmp/backend.tar.gz; if [ ! -d "venv" ]; then python3 -m venv venv; fi; source venv/bin/activate; pip install --upgrade pip --quiet; pip install -r requirements.txt --quiet; mkdir -p logs; pm2 stop all 2>/dev/null || true; pm2 delete all 2>/dev/null || true; lsof -ti:8000 | xargs kill -9 2>/dev/null || true; sleep 2; pm2 start ecosystem.config.js; pm2 save; sleep 5'
          rm /tmp/backend.tar.gz

  deploy-dev:
    name: Deploy Development
    runs-on: ubuntu-latest
    needs: check
    if: github.ref == 'refs/heads/development' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - run: ssh-keyscan -H api.yeb-ich.com >> ~/.ssh/known_hosts
      - run: |
          cd backend
          tar -czf /tmp/backend-dev.tar.gz .
          scp /tmp/backend-dev.tar.gz scroll@api.yeb-ich.com:/tmp/
          ssh scroll@api.yeb-ich.com 'set -e; BACKEND_DIR="/home/scroll/backend"; mkdir -p "$BACKEND_DIR"; cd "$BACKEND_DIR"; tar -xzf /tmp/backend-dev.tar.gz; rm /tmp/backend-dev.tar.gz; if [ ! -d "venv" ]; then python3 -m venv venv; fi; source venv/bin/activate; pip install --upgrade pip --quiet; pip install -r requirements.txt --quiet; mkdir -p logs; pm2 stop all 2>/dev/null || true; pm2 delete all 2>/dev/null || true; lsof -ti:8000 | xargs kill -9 2>/dev/null || true; sleep 2; pm2 start ecosystem.config.js; pm2 save; sleep 5'
          rm /tmp/backend-dev.tar.gz
